---
title: "Homework 3"
subtitle: "Submission 1, Spring 2026"
author: "Srijon Sarkar"
format:
  pdf:
    output-file: "sarkar-s-hwk3-1"
    output-ext:  "pdf"
    header-includes:
      - \usepackage{float}
      - \floatplacement{table}{H}
---

```{r}
#| include: false

options(repos = c(CRAN = "https://cloud.r-project.org"))

if (!require("pacman")) install.packages("pacman")
pacman::p_load(tidyverse, ggplot2, dplyr, lubridate, stringr, readxl, data.table, gdata, scales, data.table)


data.2010 <- read.csv('../data/data-2010.csv')
data.2011 <- read.csv('../data/data-2011.csv')
data.2012 <- read.csv('../data/data-2012.csv')
data.2013 <- read.csv('../data/data-2013.csv')
data.2014 <- read.csv('../data/data-2014.csv')
data.2015 <- read.csv('../data/data-2015.csv')

fix_type <- function(df) {
  df$org_parent <- as.character(df$org_parent)
  df
}

data.2011 <- fix_type(data.2011)

data.full <- bind_rows(data.2010, data.2011, data.2012, data.2013, data.2014, data.2015)  %>%
  mutate(market_share = avg_enrollment / avg_enrolled)
```

## Problem 1

```{r}
#| echo: false
#| warning: false

summary_table <- data.full %>%
  group_by(year) %>%
  summarise(
    'Average Star Rating' = round(mean(Star_Rating, na.rm = TRUE), 2),
    'Average Enrollments' = round(mean(avg_enrollment, na.rm = TRUE), 2),
    'Average Market Share' = round(mean(market_share, na.rm = TRUE), 4),
    'Total Number Of Plans' = n()
  )

print(summary_table)
```

## Problem 2

```{r}
#| echo: false
#| warning: false

without_rating_table <- data.full %>%
  filter(is.na(Star_Rating)) %>%
  group_by(year) %>%
  summarise(
    'Average Enrollments' = round(mean(avg_enrollment, na.rm = TRUE), 2),
    'Average Market Share' = round(mean(market_share, na.rm = TRUE), 4),
    'Total Number Of Plans' = n()
  )

print(without_rating_table)
```

## Problem 3

```{r}
#| echo: false
#| warning: false

data.full %>%
  filter(year %in% c(2010, 2012, 2015), !is.na(Star_Rating)) %>%
  mutate(year = as.factor(year)) %>%
  ggplot(aes(x = as.factor(Star_Rating))) +
  geom_bar() +
  facet_wrap(~ year) +
  labs(
    title = "Distribution of Star Ratings over 2010, 2012, and 2015",
    x = "Star Rating",
    y = "Number Of Plans"
  ) +
  theme_minimal()
```

We note that there is a steep decrease in the number of high-rated plans in 2010, whereas in 2012, the difference is less stark, and in 2015, we notice an improvement, with the existence of a larger number of high-rated plans.

## Problem 4

```{r}
#| echo: false
#| warning: false

data.full <- data.full %>%
  mutate(
    star_3   = as.integer(Star_Rating == 3),
    star_35  = as.integer(Star_Rating == 3.5),
    star_4   = as.integer(Star_Rating == 4),
    star_45  = as.integer(Star_Rating >= 4.5)
  )

estimate <- list()

for(yr in 2010:2015){
  ols <- lm(market_share ~ star_3 + star_35 + star_4 + star_45, 
            data = data.full %>% filter(year == yr, !is.na(Star_Rating), !is.na(market_share)))
  estimate[[as.character(yr)]] <- coef(ols)
}

ols_table <- as.data.frame(estimate)
colnames(ols_table) <- c("2010", "2011", "2012", "2013", "2014", "2015")
rownames(ols_table) <- c("Excluded (<= 2.5 stars)", "3 Stars", "3.5 Stars", "4 Stars", ">= 4.5 Stars")

print(round(ols_table, 4))
```

## Problem 5

```{r}
#| include: false

quality_vars <- c(
  "breastcancer_screen",
  "rectalcancer_screen",
  "cv_diab_cholscreen",
  "glaucoma_test",
  "monitoring",
  "flu_vaccine",
  "pn_vaccine",
  "physical_health",
  "mental_health",
  "osteo_test",
  "physical_monitor",
  "primaryaccess",
  "osteo_manage",
  "diab_healthy",
  "bloodpressure",
  "ra_manage",
  "copd_test",
  "bladder",
  "falling",
  "nodelays",
  "doctor_communicate",
  "carequickly",
  "customer_service",
  "overallrating_care",
  "overallrating_plan",
  "complaints_plan",
  "appeals_timely",
  "appeals_review",
  "leave_plan",
  "audit_problems",
  "hold_times",
  "info_accuracy",
  "ttyt_available"
)

library(dplyr)

data.2010 <- data.2010 %>%
  rowwise() %>%
  mutate(
    raw_rating = mean(c_across(all_of(quality_vars)), na.rm = TRUE)
  ) %>%
  ungroup()
```

```{r}
#| echo: false
#| warning: false

round_up_counts <- data.2010 %>%
  filter(!is.na(raw_rating)) %>%
  filter(!is.na(partc_score)) %>%
  mutate(
    round_ups = case_when(
      raw_rating >= 2.75 & partc_score == 3.0  ~ "Rounded up to 3",
      raw_rating >= 3.25 & partc_score == 3.5  ~ "Rounded up to 3.5",
      raw_rating >= 3.75 & partc_score == 4.0  ~ "Rounded up to 4",
      raw_rating >= 4.25 & partc_score == 4.5  ~ "Rounded up to 4.5",
      raw_rating >= 4.75 & partc_score == 5.0  ~ "Rounded up to 5",
      TRUE ~ NA_character_
    )
  ) %>%
  filter(!is.na(round_ups)) %>%
  count(round_ups) %>%
  rename('Star Rating' = round_ups, 'Corresponding Number Of Plans' = n)

print(round_up_counts)
```

## Problem 6

```{r}
#| include: false

ma_25star_candidates <- data.2010 %>%
  filter(
    !is.na(raw_rating),
    !is.na(partc_score),
    Star_Rating %in% c(2.5, 3)
  )

n_candidates_total <- nrow(ma_25star_candidates)
n_candidates_by_score <- ma_25star_candidates %>% count(partc_score)

ma_25star <- ma_25star_candidates %>%
  filter(
    raw_rating >= 2.5,
    raw_rating <= 3,
    (raw_rating >= 2.75 & Star_Rating == 3) | (raw_rating < 2.75 & Star_Rating == 2.5)
  )

ma.rd1 <- ma_25star %>%
  mutate(market_share = avg_enrollment / avg_enrolled,
         score = raw_rating - 2.75,
         treat = (score>=0),
         window = (score>=-.125 & score<=.125),
         score_treat=score*treat)

library(rdrobust)

star25.1 <- lm(market_share ~ score + treat + score_treat, data= (ma.rd1 %>% filter(window==TRUE)))
est1 <- as.numeric(star25.1$coef[3])
```

```{r}
#| include: false

ma_25star_candidates <- data.2010 %>%
  filter(
    !is.na(raw_rating),
    !is.na(partc_score),
    Star_Rating %in% c(3, 3.5)
  )

n_candidates_total <- nrow(ma_25star_candidates)
n_candidates_by_score <- ma_25star_candidates %>% count(partc_score)

ma_25star <- ma_25star_candidates %>%
  filter(
    raw_rating >= 3,
    raw_rating <= 3.5,
    (raw_rating >= 3.25 & Star_Rating == 3.5) | (raw_rating < 3.25 & Star_Rating == 3)
  )

ma.rd2 <- ma_25star %>%
  mutate(market_share = avg_enrollment / avg_enrolled,
         score = raw_rating - 3.25,
         treat = (score>=0),
         window = (score>=-.125 & score<=.125),
         score_treat=score*treat)

library(rdrobust)

star25.2 <- lm(market_share ~ score + treat + score_treat, data= (ma.rd2 %>% filter(window==TRUE)))
est2 <- as.numeric(star25.2$coef[3])
```

```{r}
#| echo: false
#| warning: false

# our two estimates
est1 <- as.numeric(star25.1$coef[3])
est2 <- as.numeric(star25.2$coef[3])

comparison_table <- data.frame(row.names = c("RD Estimate"), `3 vs 3.5` = est1, `2.5 vs 3` = est2 )

print(comparison_table)
```

## Problem 7

```{r}
#| include: false

ma_25star_candidates <- data.2010 %>%
  filter(
    !is.na(raw_rating),
    !is.na(partc_score),
    Star_Rating %in% c(2.5, 3)
  )

n_candidates_total <- nrow(ma_25star_candidates)
n_candidates_by_score <- ma_25star_candidates %>% count(partc_score)

ma_25star <- ma_25star_candidates %>%
  filter(
    raw_rating >= 2.5,
    raw_rating <= 3,
    (raw_rating >= 2.75 & Star_Rating == 3) | (raw_rating < 2.75 & Star_Rating == 2.5)
  )

ma.rd1 <- ma_25star %>%
  mutate(market_share = avg_enrollment / avg_enrolled,
         score = raw_rating - 2.75,
         treat = (score>=0),
         window1 = (score>=-.1 & score<=.1),
         window2 = (score>=-.12 & score<=.12),
         window3 = (score>=-.13 & score<=.13),
         window4 = (score>=-.14 & score<=.14),
         window5 = (score>=-.15 & score<=.15),
         score_treat=score*treat)

library(rdrobust)

star25.1 <- lm(market_share ~ score + treat + score_treat, data= (ma.rd1 %>% filter(window1==TRUE)))
star25.2 <- lm(market_share ~ score + treat + score_treat, data= (ma.rd1 %>% filter(window2==TRUE)))
star25.3 <- lm(market_share ~ score + treat + score_treat, data= (ma.rd1 %>% filter(window3==TRUE)))
star25.4 <- lm(market_share ~ score + treat + score_treat, data= (ma.rd1 %>% filter(window4==TRUE)))
star25.5 <- lm(market_share ~ score + treat + score_treat, data= (ma.rd1 %>% filter(window5==TRUE)))
est1 <- as.numeric(star25.1$coef[3])
est2 <- as.numeric(star25.2$coef[3])
est3 <- as.numeric(star25.3$coef[3])
est4 <- as.numeric(star25.4$coef[3])
est5 <- as.numeric(star25.5$coef[3])
```

```{r}
#| echo: false
#| warning: false

library(ggplot2)

# Create a dataframe of estimates and bandwidths
rd_results <- data.frame(
  bandwidth = c(0.10, 0.12, 0.13, 0.14, 0.15),
  estimate  = c(est1, est2, est3, est4, est5)
)

# Add confidence intervals
se_list <- c(
  summary(star25.1)$coef[3, 2],
  summary(star25.2)$coef[3, 2],
  summary(star25.3)$coef[3, 2],
  summary(star25.4)$coef[3, 2],
  summary(star25.5)$coef[3, 2]
)

rd_results <- rd_results %>%
  mutate(
    se    = se_list,
    ci_lo = estimate - 1.96 * se,
    ci_hi = estimate + 1.96 * se
  )

# Plot
ggplot(rd_results, aes(x = bandwidth, y = estimate)) +
  geom_point(size = 3, color = "steelblue") +
  geom_line(color = "steelblue") +
  geom_errorbar(aes(ymin = ci_lo, ymax = ci_hi), width = 0.003, color = "steelblue") +
  geom_hline(yintercept = 0, linetype = "dashed", color = "red") +
  scale_x_continuous(breaks = rd_results$bandwidth) +
  labs(
    title    = "RD Estimates at 2.5-Star Threshold",
    subtitle = "Effect of 3-Star Rating on Market Share",
    x        = "Bandwidth",
    y        = "Estimated Treatment Effect"
  ) +
  theme_minimal()
```

```{r}
#| include: false

ma_25star_candidates <- data.2010 %>%
  filter(
    !is.na(raw_rating),
    !is.na(partc_score),
    Star_Rating %in% c(3, 3.5)
  )

n_candidates_total <- nrow(ma_25star_candidates)
n_candidates_by_score <- ma_25star_candidates %>% count(partc_score)

ma_25star <- ma_25star_candidates %>%
  filter(
    raw_rating >= 3,
    raw_rating <= 3.5,
    (raw_rating >= 3.25 & Star_Rating == 3.5) | (raw_rating < 3.25 & Star_Rating == 3)
  )

ma.rd2 <- ma_25star %>%
  mutate(market_share = avg_enrollment / avg_enrolled,
         score = raw_rating - 3.25,
         treat = (score>=0),
         window1 = (score>=-.1 & score<=.1),
         window2 = (score>=-.12 & score<=.12),
         window3 = (score>=-.13 & score<=.13),
         window4 = (score>=-.14 & score<=.14),
         window5 = (score>=-.15 & score<=.15),
         score_treat=score*treat)

library(rdrobust)

star25.1 <- lm(market_share ~ score + treat + score_treat, data= (ma.rd2 %>% filter(window1==TRUE)))
star25.2 <- lm(market_share ~ score + treat + score_treat, data= (ma.rd2 %>% filter(window2==TRUE)))
star25.3 <- lm(market_share ~ score + treat + score_treat, data= (ma.rd2 %>% filter(window3==TRUE)))
star25.4 <- lm(market_share ~ score + treat + score_treat, data= (ma.rd2 %>% filter(window4==TRUE)))
star25.5 <- lm(market_share ~ score + treat + score_treat, data= (ma.rd2 %>% filter(window5==TRUE)))
est1 <- as.numeric(star25.1$coef[3])
est2 <- as.numeric(star25.2$coef[3])
est3 <- as.numeric(star25.3$coef[3])
est4 <- as.numeric(star25.4$coef[3])
est5 <- as.numeric(star25.5$coef[3])
```

```{r}
#| echo: false
#| warning: false

library(ggplot2)

# Create a dataframe of estimates and bandwidths
rd_results <- data.frame(
  bandwidth = c(0.10, 0.12, 0.13, 0.14, 0.15),
  estimate  = c(est1, est2, est3, est4, est5)
)

# Add confidence intervals
se_list <- c(
  summary(star25.1)$coef[3, 2],
  summary(star25.2)$coef[3, 2],
  summary(star25.3)$coef[3, 2],
  summary(star25.4)$coef[3, 2],
  summary(star25.5)$coef[3, 2]
)

rd_results <- rd_results %>%
  mutate(
    se    = se_list,
    ci_lo = estimate - 1.96 * se,
    ci_hi = estimate + 1.96 * se
  )

# Plot
ggplot(rd_results, aes(x = bandwidth, y = estimate)) +
  geom_point(size = 3, color = "steelblue") +
  geom_line(color = "steelblue") +
  geom_errorbar(aes(ymin = ci_lo, ymax = ci_hi), width = 0.003, color = "steelblue") +
  geom_hline(yintercept = 0, linetype = "dashed", color = "red") +
  scale_x_continuous(breaks = rd_results$bandwidth) +
  labs(
    title    = "RD Estimates at 3-Star Threshold",
    subtitle = "Effect of 3.5-Star Rating on Market Share",
    x        = "Bandwidth",
    y        = "Estimated Treatment Effect"
  ) +
  theme_minimal()
```

We note that findings are indeed sensitive to bandwidth choice. For instance, the treatment effect in comparing 3 versus 3.5 star plans appears to be more vivid when compared at the threshold of 0.1 as opposed to 0.15. Similarly, we see a difference in calculated effect when a bandwidth of 0.12 is chosen as opposed to 0.14 while comparsing 2.5 star plans versus 3-star plans.

## Problem 8

```{r}
#| echo: false
#| warning: false

ma_25star_candidates <- data.2010 %>%
  filter(
    !is.na(raw_rating),
    !is.na(partc_score),
    Star_Rating %in% c(2.5, 3)
  )

n_candidates_total <- nrow(ma_25star_candidates)
n_candidates_by_score <- ma_25star_candidates %>% count(partc_score)

ma_25star <- ma_25star_candidates %>%
  filter(
    raw_rating >= 2.5,
    raw_rating <= 3,
    (raw_rating >= 2.75 & Star_Rating == 3) | (raw_rating < 2.75 & Star_Rating == 2.5)
  )

ma.rd1 <- ma_25star %>%
  mutate(market_share = avg_enrollment / avg_enrolled,
         score = raw_rating - 2.75,
         treat = (score>=0),
         window = (score>=-.125 & score<=.125),
         score_treat=score*treat)

p1 <- ggplot(ma.rd1 %>% filter(window == TRUE), 
             aes(x = score, y = market_share, color = treat)) +
  geom_point(alpha = 0.4, size = 1.5) +
  geom_smooth(method = "lm", se = TRUE) +
  geom_vline(xintercept = 0, linetype = "dashed", color = "black", linewidth = 0.8) +
  scale_color_manual(values = c("FALSE" = "coral", "TRUE" = "steelblue"),
                     labels = c("2.5 Stars", "3 Stars")) +
  labs(title = "Comparing 2.5 vs 3 Stars", x = "Running Variable (Score)",
       y = "Market Share", color = "Rating") +
  theme_minimal()

ma_25star_candidates <- data.2010 %>%
  filter(
    !is.na(raw_rating),
    !is.na(partc_score),
    Star_Rating %in% c(3, 3.5)
  )

n_candidates_total <- nrow(ma_25star_candidates)
n_candidates_by_score <- ma_25star_candidates %>% count(partc_score)

ma_25star <- ma_25star_candidates %>%
  filter(
    raw_rating >= 3,
    raw_rating <= 3.5,
    (raw_rating >= 3.25 & Star_Rating == 3.5) | (raw_rating < 3.25 & Star_Rating == 3)
  )

ma.rd2 <- ma_25star %>%
  mutate(market_share = avg_enrollment / avg_enrolled,
         score = raw_rating - 3.25,
         treat = (score>=0),
         window = (score>=-.125 & score<=.125),
         score_treat=score*treat)

p2 <- ggplot(ma.rd2 %>% filter(window == TRUE), 
             aes(x = score, y = market_share, color = treat)) +
  geom_point(alpha = 0.4, size = 1.5) +
  geom_smooth(method = "lm", se = TRUE) +
  geom_vline(xintercept = 0, linetype = "dashed", color = "black", linewidth = 0.8) +
  scale_color_manual(values = c("FALSE" = "coral", "TRUE" = "steelblue"),
                     labels = c("3 Stars", "3.5 Stars")) +
  labs(title = "Comparing 3 vs 3.5 Stars", x = "Running Variable (Score)",
       y = "Market Share", color = "Rating") +
  theme_minimal()

p1
p2
```

We do see an abrupt increment in market share concording to values below and above the threshold, particularly prominent near the threshold of comparison for 2.5 stars against 3 stars (i.e., the first plot). Particularly, the drop from -0.10 to -0.05 in the upper plot and a slight increase from 0.05 to 0.10 in the lower plot.

## Problem 9

```{r}
#| echo: false
#| warning: false

summary_df <- data.frame(
  Threshold = c("2.5 vs 3 Stars", "3 vs 3.5 Stars"),
  
  # Part D counts
  PartD_Yes = c(
    sum(ma.rd1 %>% filter(window == TRUE) %>% pull(partd) == "Yes", na.rm = TRUE),
    sum(ma.rd2 %>% filter(window == TRUE) %>% pull(partd) == "Yes", na.rm = TRUE)
  ),
  PartD_No = c(
    sum(ma.rd1 %>% filter(window == TRUE) %>% pull(partd) == "No", na.rm = TRUE),
    sum(ma.rd2 %>% filter(window == TRUE) %>% pull(partd) == "No", na.rm = TRUE)
  ),
  
  # Below/Above threshold
  Below_Threshold = c(
    sum(ma.rd1 %>% filter(window == TRUE) %>% pull(score) < 0, na.rm = TRUE),
    sum(ma.rd2 %>% filter(window == TRUE) %>% pull(score) < 0, na.rm = TRUE)
  ),
  Above_Threshold = c(
    sum(ma.rd1 %>% filter(window == TRUE) %>% pull(score) >= 0, na.rm = TRUE),
    sum(ma.rd2 %>% filter(window == TRUE) %>% pull(score) >= 0, na.rm = TRUE)
  )
)

print(summary_df)
```

With a bandwidth of 0.125, we note that there are substantially more Plan D contracts below the threshold than above, for both categories. Furthermore, we see the number of plans that are HMO-approved (calculated via adjusted raw rating as HMO is constituted through Part C and defined here as score) to be significantly varying below and above the threshold. Thus, there are indeed varying characteristics between plans.

## Problem 10

The effect of increased star rating is directly proportional to a larger number of enrollments, particularly prominent from the upward and downward slopes, above and below the threshold, respectively, in the Problem 8 plot comparing 2.5-star plans against 3-star ones. However, these results are highly sensitive to the chosen bandwidth (Problems 6 & 7), as that brings an asymmetric distribution of the number of plan D contracts below and above it (Problem 9). Further, an effect is added from the fact that the 3-star ratings experience the largest number of round-ups as compared to plans above it, thereby making that region particularly volatile to analysis.

